<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unicorn Madagascar â€” Deriv Trader</title>
<!-- Lightweight Charts via CDN -->
<script type="module" src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.esm.production.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    #topBar { display:flex; align-items:center; padding:10px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    #tokenInput { flex:1; padding:5px 10px; font-size:14px; }
    #connectBtn { padding:6px 12px; margin-left:10px; cursor:pointer; }
    #status { margin-left:20px; font-weight:bold; }
    #main { display:flex; height:calc(100vh - 50px); }
    #symbolList { width:200px; background:#fff; overflow-y:auto; border-right:1px solid #ccc; }
    .symbolItem { padding:8px 12px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; transition:0.2s; }
    .symbolItem:hover { background:#f0f8ff; }
    .symbolItem.selected { background:#2962FF; color:#fff; font-weight:bold; }
    #chartContainer { flex:1; padding:10px; background:#fff; }
    #userBalance { margin-left:20px; font-weight:bold; }
</style>
</head>
<body>
<div id="topBar">
    <input type="text" id="tokenInput" placeholder="API Token Deriv">
    <button id="connectBtn">Connect</button>
    <span id="status">Disconnected</span>
    <span id="userBalance"></span>
</div>
<div id="main">
    <div id="symbolList"></div>
    <div id="chartContainer"></div>
</div>

<script type="module">
import { createChart, AreaSeries } from 'https://unpkg.com/lightweight-charts/dist/lightweight-charts.esm.production.js';

const APP_ID = 105747;
const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;

const tokenInput = document.getElementById("tokenInput");
const connectBtn = document.getElementById("connectBtn");
const statusSpan = document.getElementById("status");
const userBalance = document.getElementById("userBalance");
const symbolList = document.getElementById("symbolList");
const chartContainer = document.getElementById("chartContainer");

let ws = null;
let authorized = false;
let currentSymbol = "BOOM1000";
let chart = null;
let areaSeries = null;
let chartData = [];
let lastPrices = {};

const volatilitySymbols = ["BOOM1000","CRASH1000","BOOM900","CRASH900","BOOM600","CRASH600",
"BOOM500","CRASH500","R_100","R_75","R_50","R_25","R_10"];

function formatNum(n){ return Number(n).toFixed(2); }
function setStatus(txt){ statusSpan.textContent = txt; }

function initChart() {
    chartContainer.innerHTML = "";
    const chartOptions = { 
        layout: { textColor: 'black', background: { type: 'solid', color: 'white' } },
        grid: { vertLines:{color:"#eee"}, horzLines:{color:"#eee"} }
    };
    chart = createChart(chartContainer, chartOptions);
    areaSeries = chart.addSeries(AreaSeries, { 
        lineColor: '#2962FF', topColor: '#2962FF', bottomColor: 'rgba(41, 98, 255, 0.28)' 
    });
}

function initSymbols() {
    symbolList.innerHTML = "";
    volatilitySymbols.forEach(sym=>{
        const el = document.createElement("div");
        el.className = "symbolItem";
        el.id = `symbol-${sym}`;
        let label = sym.startsWith("BOOM") ? `BOOM ${sym.slice(4)}` :
                    sym.startsWith("CRASH") ? `CRASH ${sym.slice(5)}` :
                    `VIX ${sym.split("_")[1]}`;
        el.innerHTML = `<span>${label}</span><span class="lastPrice">0</span>`;
        el.onclick = ()=>selectSymbol(sym);
        symbolList.appendChild(el);
    });
}

function selectSymbol(sym){
    currentSymbol = sym;
    document.querySelectorAll(".symbolItem").forEach(e=>e.classList.remove("selected"));
    const el = document.getElementById(`symbol-${sym}`);
    if(el) el.classList.add("selected");
    chartData = [];
    initChart();
    subscribeTicks(sym);
}

function connectDeriv(token){
    if(ws) ws.close();
    ws = new WebSocket(WS_URL);

    ws.onopen = ()=>{
        setStatus("Connecting...");
        ws.send(JSON.stringify({ authorize: token }));
    };

    ws.onmessage = msg=>{
        const data = JSON.parse(msg.data);

        if(data.msg_type==="authorize" && data.authorize?.loginid){
            setStatus(`Connected: ${data.authorize.loginid}`);
            authorized = true;
            ws.send(JSON.stringify({ balance:1, subscribe:1 }));
            volatilitySymbols.forEach(sym => subscribeTicks(sym));
        }

        if(data.msg_type==="balance" && data.balance){
            const bal = parseFloat(data.balance.balance).toFixed(2);
            const cur = data.balance.currency;
            userBalance.textContent = `Balance: ${bal} ${cur}`;
        }

        if(data.msg_type==="tick" && data.tick){
            handleTick(data.tick);
        }
    };

    ws.onclose = ()=>setStatus("Disconnected");
    ws.onerror = e=>console.error("WS Error:", e);
}

function subscribeTicks(symbol){
    if(ws && ws.readyState === WebSocket.OPEN){
        ws.send(JSON.stringify({ ticks: symbol, subscribe:1 }));
    }
}

function handleTick(tick){
    const p = Number(tick.quote);
    lastPrices[tick.symbol] = p;

    // Update symbol list
    const el = document.getElementById(`symbol-${tick.symbol}`);
    if(el) el.querySelector(".lastPrice").textContent = formatNum(p);

    // Update chart if current symbol
    if(tick.symbol === currentSymbol){
        const time = Math.floor(tick.epoch);
        chartData.push({ time, value: p });
        if(chartData.length > 600) chartData.shift();
        areaSeries.setData(chartData);
        chart.timeScale().fitContent();
    }
}

connectBtn.onclick = ()=>{
    const token = tokenInput.value.trim();
    if(!token){ alert("Please enter your API token"); return; }
    connectDeriv(token);
};

// Init
initSymbols();
initChart();
selectSymbol(currentSymbol);

// Resize chart
window.addEventListener("resize", ()=>{
    if(chart) chart.resize(chartContainer.clientWidth, chartContainer.clientHeight);
});
</script>
</body>
</html>
