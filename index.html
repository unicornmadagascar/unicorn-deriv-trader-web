<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🦄 Unicorn Madagascar — Deriv Multiplier Trader</title>

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-main: #f8fafc;
      --bg-panel: #ffffff;
      --bg-accent: #eff6ff;
      --text-main: #1e293b;
      --text-muted: #475569;
      --border: #e2e8f0;
      --accent: #2563eb;
      --accent-light: #93c5fd;
    }

    body.dark {
      --bg-main: #0d1117;
      --bg-panel: #161b22;
      --bg-accent: #1e293b;
      --text-main: #e6edf3;
      --text-muted: #9ba6b3;
      --border: #30363d;
      --accent: #58a6ff;
      --accent-light: #1e40af;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-main);
      color: var(--text-main);
      transition: 0.3s;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: linear-gradient(90deg, var(--accent), #3b82f6);
      color: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    header h1 {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    input, select, button {
      padding: 6px 10px;
      font-size: 0.9rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: var(--bg-panel);
      color: var(--text-main);
      transition: 0.2s;
    }

    button {
      background: linear-gradient(90deg, #3b82f6, var(--accent));
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover { opacity: 0.9; }

    main {
      display: flex;
      align-items: flex-start;
      height: auto;
      min-height: 100vh;
    }

    aside#symbolPanel {
      width: 220px;
      background-color: var(--bg-panel);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 12px;
    }

    #chartSection {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      position: relative;
    }

    /* Chart container (Lightweight will render inside) */
    #chartInner {
      flex: 1;
      width: 100%;
      min-height: 500px;
      background-color: var(--bg-panel);
      border-radius: 8px;
      border: 1px solid var(--border);
      position: relative;
      z-index: 1;
      overflow: hidden;
    }

    /* small label for last price */
    .lastPriceLabel {
      position: absolute;
      right: 12px;
      top: 12px;
      background: var(--accent);
      color: white;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 600;
      z-index: 20;
      pointer-events: none;
    }

    #controls {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      background-color: var(--bg-panel);
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

    #tradeHistory, #autoTradeHistory {
      margin-top: 10px;
      background-color: var(--bg-panel);
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      height: 300px;
      overflow-y: auto;
    }

    table.trade-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .trade-table th, .trade-table td {
      padding: 6px 8px;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }

    .trade-table th {
      background-color: var(--bg-accent);
      color: var(--text-muted);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .buy { color: #16a34a; font-weight: 600; }
    .sell { color: #dc2626; font-weight: 600; }

    .theme-toggle {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      font-size: 1rem;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.2s;
    }

    .theme-toggle:hover { background: rgba(255,255,255,0.15); }
  </style>
</head>

<body>
  <header>
    <h1>🦄 Unicorn Madagascar</h1>
    <div class="header-right">
      <input id="tokenInput" placeholder="Enter Deriv API token (optional)" />
      <button id="connectBtn">Connect</button>
      <span id="status">Not connected</span>
      <span id="userBalance">💰 Balance: --</span>
      <button class="theme-toggle" id="themeToggle" title="Toggle Light/Dark">🌙</button>
    </div>
  </header>

  <main>
     <aside id="symbolPanel">
       <div id="symbolList"></div>
       <div id="plGaugeContainer">
           <!-- keep gauge canvas if you use it elsewhere -->
           <canvas id="plGauge" width="230" height="230"></canvas>
       </div>
    </aside>

    <section id="chartSection">
      <div id="gaugeDashboard"></div>

      <!-- Lightweight Chart will render inside this div -->
      <div id="chartInner">
        <div id="tooltip" class="tooltip"></div>
        <div class="lastPriceLabel" id="lastPriceLabel">--</div>
      </div>

      <div id="controls">
        <select id="modeSelect">
          <option value="simulation">Simulation</option>
          <option value="live">Live</option>
        </select>

        <label>Multiplier
          <select id="multiplier">
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="300">300</option>
            <option value="400">400</option>
            <option value="500">500</option>
          </select>
        </label>

        <label>Stake:
          <input id="stake" type="number" step="0.01" min="0.01" value="1.00" />
        </label>

        <label>TP (%)
          <input id="tp" type="number" step="0.01" value="1.0" />
        </label>

        <label>SL (%)
          <input id="sl" type="number" step="0.01" value="1.0" />
        </label>

        <label>Buy Number:
          <input id="buyNumber" type="number" min="1" max="100" value="1" />
        </label>

        <label>Sell Number:
          <input id="sellNumber" type="number" min="1" max="100" value="1" />
        </label>

        <button id="launchAutomation">Launch Automation</button>
        <button id="buyBtn">BUY</button>
        <button id="sellBtn">SELL</button>
        <button id="closeBtn">CLOSE ALL WINNING</button>
        <button id="closeBtnAll">CLOSE ALL</button>
        <div id="pnl">PnL: --</div>
      </div>

      <div id="autoTradeHistory">
        <strong>Automated trades</strong>
        <div id="autoHistoryList"></div>
      </div>

      <div id="tradeHistory">
        <strong>📜 Trade history</strong>
        <div id="historyList"></div>
      </div>
    </section>
  </main>

  <!-- your app.js should still be loaded (defer) -->
  <script src="app.js" defer></script>

  <!-- Lightweight Chart initialization (safe, minimal, exposes updateChartFromTick) -->
  <script>
    (function(){
      // wait for DOM and library loaded
      function initChart(){
        if (typeof LightweightCharts === "undefined") {
          console.error("LightweightCharts not loaded.");
          return;
        }
        const container = document.getElementById("chartInner");
        if (!container) return console.error("#chartInner not found");

        // create chart with theme-aware colors
        const styles = getComputedStyle(document.body);
        const bg = styles.getPropertyValue('--bg-panel').trim() || '#ffffff';
        const textC = styles.getPropertyValue('--text-main').trim() || '#111';
        const borderC = styles.getPropertyValue('--border').trim() || 'rgba(0,0,0,0.08)';
        const accent = styles.getPropertyValue('--accent').trim() || '#2563eb';

        const chart = LightweightCharts.createChart(container, {
          layout: { background: { color: bg }, textColor: textC },
          grid: { vertLines: { color: borderC }, horzLines: { color: borderC } },
          crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
          rightPriceScale: { borderColor: borderC },
          timeScale: { borderColor: borderC, timeVisible: true, secondsVisible: true },
          handleScroll: { mouseWheel: true, pressedMouseMove: true },
          handleScale: { axisPressedMouseMove: true, pinch: true }
        });

        // candlestick series (main)
        const candleSeries = chart.addCandlestickSeries({
          upColor: '#16a34a',
          downColor: '#dc2626',
          borderUpColor: '#16a34a',
          borderDownColor: '#dc2626',
          wickUpColor: '#16a34a',
          wickDownColor: '#dc2626'
        });

        // optional line series for latest ticks (fallback if addLineSeries available)
        let tickSeries = null;
        if (typeof chart.addLineSeries === 'function') {
          tickSeries = chart.addLineSeries({ color: accent, lineWidth: 2 });
        } else if (typeof chart.addAreaSeries === 'function') {
          tickSeries = chart.addAreaSeries();
        }

        // helper: resize chart to container width
        function resize(){
          chart.applyOptions({ width: container.clientWidth, height: Math.max(300, container.clientHeight) });
        }
        window.addEventListener('resize', resize);
        resize();

        // expose function to update from a Deriv tick
        // expected tick: { epoch: <sec>, quote: <number> }
        window.updateChartFromTick = function(tick){
          try {
            if (!tick) return;
            const t = typeof tick.epoch === 'number' ? tick.epoch : Math.floor(Date.now()/1000);
            const price = Number(tick.quote ?? tick.ask ?? tick.bid ?? tick.price);
            if (!Number.isFinite(price)) return;

            // update tick series (line)
            if (tickSeries) {
              tickSeries.update({ time: t, value: price });
            }

            // optional: update candlestick by aggregating per time unit (simple approach)
            // Here we update or append a 1-second candle (very simple)
            const lastBar = container._lastBar || null;
            const sec = t;
            if (!container._lastBar || container._lastBar.time !== sec) {
              // new bar
              const newBar = { time: sec, open: price, high: price, low: price, close: price };
              candleSeries.update(newBar);
              container._lastBar = newBar;
            } else {
              // modify existing
              const b = container._lastBar;
              b.high = Math.max(b.high, price);
              b.low = Math.min(b.low, price);
              b.close = price;
              candleSeries.update(b);
            }

            // update last price label
            const lastLabel = document.getElementById('lastPriceLabel');
            if (lastLabel) lastLabel.textContent = Number(price).toFixed(3);
          } catch (e) {
            console.warn("updateChartFromTick error", e);
          }
        };

        // apply theme initially and when theme toggled
        function applyTheme(){
          const styles = getComputedStyle(document.body);
          const bg = styles.getPropertyValue('--bg-panel').trim() || '#fff';
          const textC = styles.getPropertyValue('--text-main').trim() || '#111';
          const borderC = styles.getPropertyValue('--border').trim() || 'rgba(0,0,0,0.08)';
          chart.applyOptions({
            layout: { background: { color: bg }, textColor: textC },
            grid: { vertLines: { color: borderC }, horzLines: { color: borderC } },
            rightPriceScale: { borderColor: borderC },
            timeScale: { borderColor: borderC }
          });
        }

        // listen for theme toggle (your UI toggles body.dark)
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
          themeToggle.addEventListener('click', () => setTimeout(applyTheme, 180));
        }
        applyTheme();

        console.log("Lightweight chart initialized");
      }

      // DOMContentLoaded might already have fired because app.js is defer — ensure init after small delay
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChart);
      } else {
        setTimeout(initChart, 50);
      }
    })();
  </script>

  <script>
    // 🌗 Mode clair/sombre and some UI handlers (your original code)
    const toggleBtn = document.getElementById("themeToggle");
    const body = document.body;
    if (localStorage.getItem("theme") === "dark") {
      body.classList.add("dark");
      toggleBtn.textContent = "☀️";
    }
    toggleBtn.addEventListener("click", () => {
      body.classList.toggle("dark");
      const isDark = body.classList.contains("dark");
      toggleBtn.textContent = isDark ? "☀️" : "🌙";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });

    // Launch automation toggle
    const launchAutomationBtn = document.getElementById("launchAutomation");
    if (launchAutomationBtn) {
      launchAutomationBtn.addEventListener("click", () => {
        const isActive = launchAutomationBtn.classList.toggle("active");
        launchAutomationBtn.textContent = isActive ? "Stop Automation" : "Launch Automation";
      });
    }
  </script>
</body>
</html>
